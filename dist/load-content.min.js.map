{"version":3,"file":"load-content.min.js","sources":["../src/load-content.js"],"sourcesContent":["import \"./load-content.scss\";\n\n/* ------------------------------------------------------------------\n * <load-content> web component\n * ---------------------------------------------------------------- */\nclass LoadContent extends HTMLElement {\n\t/** sets up internal state and binds methods */\n\tconstructor() {\n\t\tsuper();\n\n\t\t/** @private {number} current page index (1-based) */\n\t\tthis.currentPage = 1;\n\n\t\t/** @private {boolean} whether another page exists */\n\t\tthis.hasNextPage = false;\n\n\t\t/** @private {string} base url to request more html from */\n\t\tthis.baseUrl = \"\";\n\n\t\t/** @private {string} default mode for content loading (append|swap) */\n\t\tthis.mode = \"append\";\n\n\t\t/** @private {string[]} css selectors whose children weâ€™ll append */\n\t\tthis.contentSelectors = [];\n\n\t\t/** @private {string} css selector to filter which children to append */\n\t\tthis.appendFilter = \"\";\n\n\t\t/** @private {number} total items that have been appended so far */\n\t\tthis.itemsShown = 0;\n\n\t\t/** @private {boolean} guard to prevent duplicate clicks while loading */\n\t\tthis.isLoading = false;\n\n\t\t/* bind so we can remove listener if element detaches */\n\t\tthis.handleClick = this.handleClick.bind(this);\n\t}\n\n\t/* --------------------------------------------------------------\n\t * lifecycle\n\t * ---------------------------------------------------------- */\n\tconnectedCallback() {\n\t\tthis.readAttributes();\n\t\tthis.addEventListener(\"click\", this.handleClick);\n\t\tthis.updateButtonState();\n\t}\n\n\tdisconnectedCallback() {\n\t\tthis.removeEventListener(\"click\", this.handleClick);\n\t}\n\n\t/* --------------------------------------------------------------\n\t * attribute helpers\n\t * ---------------------------------------------------------- */\n\t/** parses attributes into internal state */\n\treadAttributes() {\n\t\tconst _ = this;\n\t\t_.currentPage = Number(_.getAttribute(\"current-page\")) || 1;\n\t\t_.hasNextPage = _.getAttribute(\"has-next-page\") === \"true\";\n\t\t_.baseUrl = _.getAttribute(\"url\") || window.location.pathname;\n\t\t_.mode = _.getAttribute(\"mode\") || \"append\";\n\t\t_.contentSelectors = (_.getAttribute(\"targets\") || \"\")\n\t\t\t.split(\",\")\n\t\t\t.map((s) => s.trim())\n\t\t\t.filter(Boolean);\n\t\t_.appendFilter = _.getAttribute(\"append-filter\") || \"\";\n\n\t\t/* recount items currently in the dom */\n\t\t_.itemsShown = _.contentSelectors.reduce((sum, selector) => {\n\t\t\tconst el = document.querySelector(selector);\n\t\t\treturn el ? sum + el.children.length : sum;\n\t\t}, 0);\n\t}\n\n\t/* --------------------------------------------------------------\n\t * public api\n\t * ---------------------------------------------------------- */\n\t/**\n\t * resets internal + reflected state\n\t * @param {Object} opts\n\t */\n\treset(opts = {}) {\n\t\tconst _ = this;\n\t\tif (opts.currentPage !== undefined)\n\t\t\t_.setAttribute(\"current-page\", String(opts.currentPage));\n\t\tif (opts.hasNextPage !== undefined)\n\t\t\t_.setAttribute(\"has-next-page\", String(opts.hasNextPage));\n\t\tif (opts.url !== undefined) _.setAttribute(\"url\", opts.url);\n\t\tif (opts.targets !== undefined) {\n\t\t\t_.setAttribute(\n\t\t\t\t\"targets\",\n\t\t\t\tArray.isArray(opts.targets)\n\t\t\t\t\t? opts.targets.join(\", \")\n\t\t\t\t\t: String(opts.targets),\n\t\t\t);\n\t\t}\n\t\tif (opts.mode !== undefined) _.setAttribute(\"mode\", opts.mode);\n\t\tif (opts.appendFilter !== undefined)\n\t\t\t_.setAttribute(\"append-filter\", opts.appendFilter);\n\n\t\t_.readAttributes();\n\t\t_.updateButtonState();\n\n\t\t_.dispatchEvent(\n\t\t\tnew CustomEvent(\"onReset\", {\n\t\t\t\tbubbles: true,\n\t\t\t\tdetail: {\n\t\t\t\t\tcurrentPage: _.currentPage,\n\t\t\t\t\thasNextPage: _.hasNextPage,\n\t\t\t\t\titemsShown: _.itemsShown,\n\t\t\t\t},\n\t\t\t}),\n\t\t);\n\t}\n\n\t/* --------------------------------------------------------------\n\t * button state helpers\n\t * ---------------------------------------------------------- */\n\tdisable() {\n\t\tthis.setAttribute(\"disabled\", \"\");\n\t\tthis.setAttribute(\"data-state\", \"loading\");\n\t}\n\n\tenable() {\n\t\tthis.removeAttribute(\"disabled\");\n\t\tthis.setAttribute(\"data-state\", \"ready\");\n\t}\n\n\tsetComplete() {\n\t\tthis.setAttribute(\"disabled\", \"\");\n\t\tthis.setAttribute(\"data-state\", \"complete\");\n\t}\n\n\tupdateButtonState() {\n\t\tif (this.isLoading) this.disable();\n\t\telse if (!this.hasNextPage) this.setComplete();\n\t\telse this.enable();\n\t}\n\n\t/* --------------------------------------------------------------\n\t * click + fetch\n\t * ---------------------------------------------------------- */\n\tasync handleClick(evt) {\n\t\tconst _ = this;\n\t\tevt.preventDefault();\n\t\tif (!_.hasNextPage || _.isLoading) return;\n\n\t\t_.isLoading = true;\n\t\t_.updateButtonState();\n\n\t\ttry {\n\t\t\tawait _.fetchAndAppendNextPage();\n\t\t} catch (err) {\n\t\t\tconsole.error(\"load-content: failed to load next page\", err);\n\t\t} finally {\n\t\t\t_.isLoading = false;\n\t\t\t_.updateButtonState();\n\t\t}\n\t}\n\n\t/** builds ?page= param for the next request */\n\tbuildNextPageUrl() {\n\t\tconst _ = this;\n\t\tconst url = new URL(_.baseUrl, window.location.origin);\n\t\tif (_.mode === \"append\" && _.getAttribute(\"current-page\") !== null) {\n\t\t\turl.searchParams.set(\"page\", String(_.currentPage + 1));\n\t\t}\n\t\treturn url.href;\n\t}\n\n\t/** fetches next page, injects html, updates state */\n\tasync fetchAndAppendNextPage() {\n\t\tconst _ = this;\n\t\tconst response = await fetch(_.buildNextPageUrl(), {\n\t\t\tcredentials: \"same-origin\",\n\t\t});\n\t\tif (!response.ok) throw new Error(`http error ${response.status}`);\n\n\t\tconst html = await response.text();\n\t\tconst parsedDoc = new DOMParser().parseFromString(html, \"text/html\");\n\n\t\t_.contentSelectors.forEach((selector) => {\n\t\t\tconst sourceEl = parsedDoc.querySelector(selector);\n\t\t\tconst destinationEl = document.querySelector(selector);\n\n\t\t\tif (!sourceEl || !destinationEl) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`load-content: selector \"${selector}\" not found in one of the documents`,\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst elementMode = destinationEl.getAttribute(\"data-load-content\");\n\t\t\tconst shouldSwap =\n\t\t\t\telementMode === \"swap\" || (elementMode === null && _.mode === \"swap\");\n\n\t\t\tif (shouldSwap) {\n\t\t\t\t// swap entire content\n\t\t\t\tdestinationEl.innerHTML = sourceEl.innerHTML;\n\t\t\t\t_.itemsShown = destinationEl.children.length; // keep count accurate\n\t\t\t} else {\n\t\t\t\t// gather children and optionally filter\n\t\t\t\tlet childrenToAppend = Array.from(sourceEl.children);\n\t\t\t\tif (_.appendFilter) {\n\t\t\t\t\tchildrenToAppend = childrenToAppend.filter((child) =>\n\t\t\t\t\t\tchild.matches(_.appendFilter),\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tchildrenToAppend.forEach((child) => {\n\t\t\t\t\tdestinationEl.appendChild(child);\n\t\t\t\t\t_.itemsShown += 1;\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\t/* update page counter */\n\t\t_.currentPage += 1;\n\n\t\t/* read has-next-page flag from fetched markup */\n\t\tconst newLoadContentEl = parsedDoc.querySelector(\"load-content\");\n\t\tif (\n\t\t\tnewLoadContentEl &&\n\t\t\tnewLoadContentEl.getAttribute(\"has-next-page\") !== null\n\t\t) {\n\t\t\t_.hasNextPage =\n\t\t\t\tnewLoadContentEl.getAttribute(\"has-next-page\") === \"true\";\n\t\t}\n\n\t\t/* reflect new values outward */\n\t\t_.setAttribute(\"current-page\", String(_.currentPage));\n\t\t_.setAttribute(\"has-next-page\", String(_.hasNextPage));\n\n\t\t/* refresh button */\n\t\t_.updateButtonState();\n\n\t\t/* fire event for observers */\n\t\t_.dispatchEvent(\n\t\t\tnew CustomEvent(\"onContentLoaded\", {\n\t\t\t\tbubbles: true,\n\t\t\t\tdetail: {\n\t\t\t\t\tdocument: parsedDoc,\n\t\t\t\t\titemsShown: _.itemsShown,\n\t\t\t\t\tcurrentPage: _.currentPage,\n\t\t\t\t},\n\t\t\t}),\n\t\t);\n\t}\n}\n\n/* register once */\nif (!customElements.get(\"load-content\")) {\n\tcustomElements.define(\"load-content\", LoadContent);\n}\n"],"names":["LoadContent","HTMLElement","constructor","super","this","currentPage","hasNextPage","baseUrl","mode","contentSelectors","appendFilter","itemsShown","isLoading","handleClick","bind","connectedCallback","readAttributes","addEventListener","updateButtonState","disconnectedCallback","removeEventListener","_","Number","getAttribute","window","location","pathname","split","map","s","trim","filter","Boolean","reduce","sum","selector","el","document","querySelector","children","length","reset","opts","undefined","setAttribute","String","url","targets","Array","isArray","join","dispatchEvent","CustomEvent","bubbles","detail","disable","enable","removeAttribute","setComplete","evt","preventDefault","fetchAndAppendNextPage","err","console","error","buildNextPageUrl","URL","origin","searchParams","set","href","response","fetch","credentials","ok","Error","status","html","text","parsedDoc","DOMParser","parseFromString","forEach","sourceEl","destinationEl","warn","elementMode","innerHTML","childrenToAppend","from","child","matches","appendChild","newLoadContentEl","customElements","get","define"],"mappings":"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"}